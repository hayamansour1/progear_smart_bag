<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Set a new password</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      background:#f6f7fb;margin:0}
    .card{max-width:640px;margin:72px auto;background:#fff;border-radius:12px;
      box-shadow:0 10px 30px rgba(16,24,40,.06);padding:28px 24px}
    h1{font-size:28px;margin:0 0 18px}
    input{width:100%;padding:14px 16px;border:1px solid #d0d5dd;border-radius:10px;font-size:16px}
    .row{margin:12px 0}
    button{width:100%;padding:14px 16px;border:0;border-radius:10px;background:#1f3a93;color:#fff;
      font-weight:700;font-size:16px;cursor:pointer}
    .err{color:#d92d20;margin-top:10px}
    .ok{color:#067647;margin-top:10px}
  </style>
</head>
<body>
  <div class="card">
    <h1>Set a new password</h1>
    <div class="row"><input id="p1" type="password" placeholder="New password" /></div>
    <div class="row"><input id="p2" type="password" placeholder="Confirm new password" /></div>
    <div class="row"><button id="btn">Update password</button></div>
    <div id="msg" class="row"></div>
  </div>

  <script>
    // 👇 عبّي القيمتين من README أو .env (نفس اللي تستعملينه في التطبيق)
    const SUPABASE_URL = "https://ywulwmvyhagsdfnzyvab.supabase.co";
    const SUPABASE_ANON_KEY = "sb_secret_jMcmm8ZlIPct87pKlCOZiA_ds6iQGrL";

    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Parse fragment: #access_token=...&refresh_token=...&type=recovery
    function parseFragment() {
      const frag = location.hash.startsWith('#') ? location.hash.slice(1) : '';
      const out = {};
      for (const pair of frag.split('&')) {
        const [k, v] = pair.split('=');
        if (k) out[decodeURIComponent(k)] = decodeURIComponent(v || '');
      }
      return out;
    }

    async function ensureSession() {
      const f = parseFragment();
      // في روابط Supabase القديمة/الافتراضية يرسل access_token/refresh_token
      if (f.access_token && f.refresh_token) {
        const { data, error } = await client.auth.setSession({
          access_token: f.access_token,
          refresh_token: f.refresh_token,
        });
        if (error) throw error;
        return data.session;
      }
      // بعض القوالب ترسل token_hash في query ?code=... — جرّبي تبادل الكود
      const url = new URL(location.href);
      const code = url.searchParams.get('code');
      if (code) {
        const { data, error } = await client.auth.exchangeCodeForSession(code);
        if (error) throw error;
        return data.session;
      }
      throw new Error('No auth parameters found in URL');
    }

    function show(el, text, ok=false){
      el.className = ok ? 'row ok' : 'row err';
      el.textContent = text;
    }

    document.getElementById('btn').addEventListener('click', async () => {
      const msg = document.getElementById('msg');
      msg.textContent = '';
      try {
        const p1 = document.getElementById('p1').value.trim();
        const p2 = document.getElementById('p2').value.trim();
        if (p1.length < 6) return show(msg, 'Password must be at least 6 characters.');
        if (p1 !== p2)   return show(msg, 'Passwords do not match.');

        // 1) ثبّت الجلسة من الرابط
        await ensureSession();

        // 2) حدّث كلمة المرور
        const { error } = await client.auth.updateUser({ password: p1 });
        if (error) throw error;

        show(msg, 'Password updated successfully. You can now sign in in the app.', true);
      } catch (e) {
        show(msg, e.message || String(e));
      }
    });
  </script>
</body>
</html>
