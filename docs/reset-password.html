<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Set a new password</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:#f6f7fb;margin:0}
    .wrap{max-width:520px;margin:48px auto;background:#fff;border-radius:12px;padding:24px 28px;box-shadow:0 4px 24px rgba(0,0,0,.06)}
    h1{font-size:28px;margin:0 0 18px}
    .muted{color:#566}
    input{width:100%;padding:12px 14px;border:1px solid #ccd2e0;border-radius:10px;font-size:16px;background:#fff}
    .row{margin:12px 0}
    button{width:100%;padding:12px 16px;border-radius:10px;border:0;background:#1e3e96;color:#fff;font-size:16px;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .msg{margin-top:12px;font-size:14px}
    .ok{color:#177245}
    .err{color:#b00020}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Set a new password</h1>
    <p class="muted">Enter your new password below.</p>

    <div class="row"><input id="p1" type="password" placeholder="New password" autocomplete="new-password"></div>
    <div class="row"><input id="p2" type="password" placeholder="Confirm password" autocomplete="new-password"></div>
    <div class="row"><button id="btn">Update password</button></div>
    <div id="msg" class="msg"></div>
  </div>

  <script>
    // ـــــــــــــ ضعي مفاتيح مشروعك (الـ anon key مسموح نشره) ـــــــــــــ
    const SUPABASE_URL = "https://ywulwmvyhagsdfnzyvab.supabase.co";
    const SUPABASE_ANON_KEY = "sb_secret_jMcmm8ZlIPct87pKlCOZiA_ds6iQGrL";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $ = (id) => document.getElementById(id);
    const btn = $('btn'), p1 = $('p1'), p2 = $('p2'), msg = $('msg');

    // اقرأ query/hash من الرابط
    const qp = new URLSearchParams(window.location.search);
    const hash = window.location.hash.startsWith('#') ? window.location.hash.slice(1) : window.location.hash;
    const hp = new URLSearchParams(hash);

    // حاولي إنشاء جلسة من الرابط (يدعم الطريقتين: code أو access/refresh)
    async function ensureSessionFromLink() {
      try {
        const code = qp.get('code') || qp.get('token') || null;
        if (code) {
          // الشكل الأحدث من Supabase: ?code=...
          await supabase.auth.exchangeCodeForSession(code);
          return true;
        }
        const at = qp.get('access_token') || hp.get('access_token');
        const rt = qp.get('refresh_token') || hp.get('refresh_token');
        if (at && rt) {
          await supabase.auth.setSession({ access_token: at, refresh_token: rt });
          return true;
        }
      } catch (e) {
        console.warn('set/exchange session failed', e);
      }
      // لو فيه جلسة أصلاً، ممتاز
      const { data } = await supabase.auth.getSession();
      return !!data.session;
    }

    async function updatePassword() {
      msg.textContent = '';
      msg.className = 'msg';

      if (!p1.value || p1.value.length < 6) {
        msg.textContent = 'Password must be at least 6 characters.';
        msg.classList.add('err');
        return;
      }
      if (p1.value !== p2.value) {
        msg.textContent = 'Passwords do not match.';
        msg.classList.add('err');
        return;
      }

      btn.disabled = true;

      // تأكدي أن لدينا جلسة صالحة قبل التحديث
      const ok = await ensureSessionFromLink();
      if (!ok) {
        msg.textContent = 'Auth session missing! Please open the reset link again.';
        msg.classList.add('err');
        btn.disabled = false;
        return;
      }

      try {
        const { error } = await supabase.auth.updateUser({ password: p1.value });
        if (error) throw error;
        msg.textContent = 'Password updated successfully. You can close this tab and sign in in the app.';
        msg.classList.add('ok');
      } catch (e) {
        msg.textContent = e.message || 'Failed to update password.';
        msg.classList.add('err');
      } finally {
        btn.disabled = false;
      }
    }

    btn.addEventListener('click', updatePassword);

    // اختياري: حاولي تهيئة الجلسة بمجرد فتح الصفحة (تسهل على المستخدم)
    ensureSessionFromLink().then((ok) => {
      if (!ok) {
        msg.textContent = 'We couldn’t verify your reset link. Try clicking the email link again.';
        msg.classList.add('err');
      }
    });
  </script>
</body>
</html>
